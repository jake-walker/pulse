<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<title>Pulse</title>
		<link rel="stylesheet" href="bootstrap.min.css">
	</head>
	<body>
		<div style="display: none;" id="chat-screen">
			<div class="container" style="padding-top: 2em; padding-bottom: 2em; font-family: monospace; display: flex; flex-direction: column; max-height:100vh; min-height:100vh;">
				<div id="chat-header">
					<div class="row">
						<div class="col-sm-3">
							<b id="chatServerName">Server Name</b>
						</div>
						<div class="col-sm-9"></div>
					</div>
					<hr>
				</div>
				<div id="messages" style="overflow-y: scroll; flex: 1; overflow-x: hidden;">
				</div>
				<br>
				<div class="chat-input">
					<div class="row">
						<div class="col-md-10">
							<label class="sr-only" for="messageInput">Message</label>
						  <input type="text" class="form-control form-control-sm mb-2 mr-sm-2 mb-sm-0" id="messageInput" style="width: 100%;">
						</div>
						<div class="col-md-2">
							<button type="button" class="btn btn-primary btn-sm" style="width: 100%;" id="send-button">Send</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div style="display: none;" id="loading-screen">
			<div style="display:flex;justify-content:center;align-items:center;height:100vh;width:100vw;">
				<center>
					<h1 id="loading-screen-text">Loading...</h1>
				</center>
			</div>
		</div>

		<div style="display: none;" id="welcome-screen">
			<div style="display:flex;justify-content:center;align-items:center;height:100vh;width:100vw;">
				<center>
					<h1>Pulse</h1>
					<div class="form-group">
				    <label for="serverSelect" class="inline-block">Server</label>
				    <select class="form-control" id="serverSelect">
				      <option selected="true" value="194.135.84.73:6666">Official Echo</option>
				    </select>
				  </div>
					<div class="form-group">
				    <label for="username">Username</label>
				    <input type="text" class="form-control" id="username">
				  </div>
					<button type="button" class="btn btn-primary" id="connectButton">Connect</button>
				</center>
			</div>
		</div>

		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
		<script src="jquery-3.2.1.min.js"></script>
		<script src="tether.min.js"></script>
		<script src="bootstrap.min.js"></script>
		<script>if (window.module) module = window.module;</script>
		<script>
			var net = require("net");
			var utf8 = require("utf8");

			var client = new net.Socket();

			client.on("data", function(data) {
			  data = data.toString("utf-8");
		    let username = data.substring(data.indexOf("[")+1,data.indexOf("]"));
		    if (!username) { username = "?" }
		    let message = data.replace("[" + username + "]", "").split();
				let now = new Date();
		    $("#messages").append(`
					<div class="row" class="message">
						<div class="col-sm-1">
							<span style="color: #BDBDBD;">` + now.getHours() + `:` + now.getMinutes() + `</span>
						</div>
						<div class="col-sm-2" style="border-right-color: #BDBDBD; border-right-style: solid; border-right-width: 1px;">
							<span class="float-right text-primary">` + username + `</span>
						</div>
						<div class="col-sm-9">
							<span>` + message + `</span>
						</div>
					</div>
					`);
				// scroll to bottom
				$("#messages").scrollTop($("#messages")[0].scrollHeight);
			});

			$(document).ready(function() {
				$("#welcome-screen").fadeIn(1000);
			});

			$("#connectButton").click(function() {
				$("#welcome-screen").hide();
				$("#loading-screen-text").text("Connecting...");
				$("#loading-screen").show();
				client.connect(parseInt($("#serverSelect").val().split(":")[1]), $("#serverSelect").val().split(":")[0], function() {
					$("#loading-screen-text").text("Logging in...");
					setTimeout(function() { // wait for server to handle connection
						client.write(utf8.encode($("#username").val()));
						$("#loading-screen").hide();
						$("#chat-screen").show();
						$("#messages").html("");
						$("#chatServerName").text($("#serverSelect").val());
						let now = new Date();
						$("#messages").append(`
							<div class="row" class="message">
								<div class="col-sm-1">
									<span style="color: #BDBDBD;">` + now.getHours() + `:` + now.getMinutes() + `</span>
								</div>
								<div class="col-sm-2" style="border-right-color: #BDBDBD; border-right-style: solid; border-right-width: 1px;">
									<span class="float-right text-success">Pulse</span>
								</div>
								<div class="col-sm-9">
									<span class="text-sucess">Connected to ` + $("#serverSelect").val() + ` as ` + $("#username").val() + `!</span>
								</div>
							</div>
							`);
					}, 1000);
				});
			});

			$("#send-button").click(function() {
				sendMessage($("#messageInput").val());
				$("#messageInput").val("");
			});

			$("#messageInput").keypress(function(e) {
				var keycode = (e.keyCode ? e.keyCode : e.which);
				if (keycode == "13") {
					sendMessage($("#messageInput").val());
					$("#messageInput").val("");
				}
			});

			function sendMessage(message) {
				if (message) {
					if (message.trim() != "") {
						client.write(utf8.encode(message));
					} else {
						console.log("Ignoring blank message. Not Sending.");
					}
				}
			}
		</script>
	</body>
</html>
